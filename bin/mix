#!/usr/bin/env bash

# mithrix (Shortened to mix cause it is too long)
# Basically a minimal nix manager which collects all my nix related scripts.
# Most of them will be "aliases" to normal nix commands, but cooler (I wish).
# 
# Risk of Rain 2 spoiler ahead !!! Bet you did not expect this in a script.
# For those rare but precious Risk of Rain 2 fans out there, Mithrix is the
# final boss, whose nickname is the King of Nothing. Coincidentally, nix
# also means nothing, so Mithrix is the King of Nix, so I think they are
# thrustworthy enough for my nix-related activities.

# TODO: look at the ones which takes passwords in more carefully, look at
# something like sudo -A or maybe simply calling the script with sudo
 
# Checks if nix has to be rebooted by checking if the kernel, initrd, or
# kernel-modules have changed.
check() {
    built_prefix="/nix/var/nix/profiles/system"
    booted_prefix="/run/booted-system"

    modules=("initrd" "kernel" "kernel-modules")
    built_prefix="/nix/var/nix/profiles/system"
    booted_prefix="/run/booted-system"

    modules=("initrd" "kernel" "kernel-modules")
    needs_reboot=false
    for i in "${modules[@]}"; do
	echo ""
	echo "--- Checking '${i}' Changes ---"
	built=$(readlink "${built_prefix}/${i}")
	booted=$(readlink "${booted_prefix}/${i}")
	pre=" "
	if [ "$built" != "$booted" ]; then
	    pre="x"
	    needs_reboot=true
	fi
	echo "${pre} ${booted#*-} --> ${built#*-}"
	echo ""
    done

    if $needs_reboot; then
	echo "Reboot is needed!"
    else
	echo "Reboot is not needed..."
    fi
}

# Prints the differences between two closures. The default, when no arguements
# is providied, is to perform boot comparison  
#
#   $1(optional): comparison type: current (default), newest
#
# * Current compares the current closure with the booted one
# * Newest compares the newest closure with the booted one
# Example usage: `mix diff`, `mix diff current`, `mix diff newest`
diff() {
    if [ -z "${1}" ] || [ "${1}" = "current" ]; then
	nix store diff-closures /run/booted-system /run/current-system
    elif [ "${1}" = "newest" ]; then
	new=$(ls /nix/var/nix/profiles/ | tail -n 1)
	nix store diff-closures /run/booted-system "/nix/var/nix/profiles/${new}"
    fi
}

# Runs garbage collect on generations older than a week. I find this to be a
# reasonable time frame and generally have no desire to change it. Pass in
# --system flag to clean the entire system. Requires typing in your sudo
# password. This does NOT optimise the store afterwards.
#
# Example usage: `mix gc`, `mix gc --system`
gc() {
    nix-collect-garbage --delete-older-than 7d 
    if [ "$#" = 1 ] && [ "$1" = "--system" ]; then
	 read -sr -p "Enter your password: " pw
	 echo "$pw" | sudo -S nix-collect-garbage --delete-older-than 7d 
    fi;
}

# Initializes a flake using templates defined in "$FLAKE/templates". Passing
# in an argument results in using that template, otherwise, a select menu is
# brought up to prompt the user for the template type.
#
#   $1(optional): template to use
#
# Example usage: `mix dev c`, `mix dev`
dev() {
    dir="${FLAKE}/templates"
    if [ ! -d "$dir" ]; then
	echo "Template directory $dir does not exist, aborting..."
	exit 1
    fi

    template=$1
    if [ -z "${template}" ]; then
	echo "hi"
	mapfile -d ' ' templates < <(nix flake show "$dir" --json --no-pretty | jq -r '.templates | keys | @sh' | tr -d \')

	PS3="Choose a template (enter number): "
	select choice in "${templates[@]}"; do
	    if [ "$REPLY" -le "${#templates[@]}" ]; then
		echo "Using '${choice}' template"
		break
	    else
		echo "Using 'default' template"
		break
	    fi
	done
    fi
    
    if [ -n "$template" ]; then
	nix flake init -t "${dir}#${template}"
    else
	echo "Aborting, no template was instantiated..."
    fi
}

# Long on purpose, this is a very scary command. This changes the password of a
# user by setting in in the '\nix\persist\passwords\username' file which is needed
# when nix-impermanence is used. Run this with sudo. Example usage
#
#    mix change-password username
#
# The script will then prompt you for the passwords. The password is hashed using
# yescript. This requires directly calling sudo as it is way more priviledged than
# something like garbage collecting some random person's old nix profiles.  
change-password() {
    username="$1"
    read -sr -p "Enter your new password: " pw1
    echo
    read -sr -p "Enter the password again: " pw2
    echo

    if [ "$pw1" -ne "$pw2" ]; then
	echo "Passwords do not match"
	exit 1
    elif [ -z "$pw1" ]; then
	echo "Password is empty"
	exit 1
    fi

    mkpasswd -m yescrypt "$pw1" > "\nix\persist\passwords\$username"
}

if [ "$#" = 0 ]; then
    echo "help"
    exit 1
fi

action="${1}"
shift
case "${action}" in
    "diff")
	diff "$@"
	;;
    "check")
	check "$@"
	;;
    "gc")
	gc "$@"
	;;
    "dev")
	dev "$@"
	;;
    "change-password")
	change-password "$@"
	;;
    *)
	echo "help"
esac
