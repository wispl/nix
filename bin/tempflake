#!/usr/bin/env bash

# Menu for selecting a flake template to copy from a specified template
# directory to the current directory.
#
# If a flake.nix already exists, prompts the user to overwrite it.

# Directory where flake templates are searched, override as desired
template_dir="${HOME}/flakes/templates/"

# Passes all arguments to the chosen menu.
#
# The menu must support setting a prompt using '-p PROMPT'. Change all such
# lines if it does not.
#
# The menu must support a dmenu mode where it accepts all stdin.
menu() {
	fuzzel --counter -d $@
}

# Get all files the template directory as an absolute path
files=("${template_dir}"*)
# Change path to have only the path name instead
filenames=("${files[@]#"${template_dir}"}")
# Remove .nix suffix
filenames=("${filenames[@]%%.*}")

choice=$(IFS=$'\n'; echo "${filenames[*]}" | menu -p "Template ")
# Convert back to absolute path
template="${template_dir}${choice}.nix"

flake="flake.nix"
envrc=".envrc"

if [ -e "$flake" ]; then
	echo "flake.nix already exists in this directory! Overwrite it? [y/N]"
	read -e reply
	case "$reply" in
		[yY]*)
			cp "$template" "$flake"
			;;
		*)
			echo "No template was copied."
			exit 0
			;;
	esac
else
	cp "$template" "$flake"
fi
