#!/usr/bin/env bash

# Searches and performs actions on notes in a directories. This searches in a
# predefined directory (see 'notes_dir') for .pdf and .tex files. By default,
# this assumes the PDF file is named 'main.pdf' and the main TeX file is
# 'main.tex'. This script depends on 'fuzzel' as the menu.
#
# Make sure that your mimelists are configured properly as this script relies
# on using xdg-open to open PDF files and edit TeX files!

# For recusively matching files
shopt -s extglob globstar nullglob

# Directory to search course notes for
notes_dir="${HOME}/org/courses"
# Main name of the PDF and TeX file
main_name="main"

# Passes all arguments to the chosen menu.
#
# The menu must support setting a prompt using '-p PROMPT'. Change all such
# lines if it does not.
#
# The menu must support a dmenu mode where it accepts all stdin.
menu() {
    fuzzel --counter -d "$@"
}

# Find all PDF files
pdfs=("${notes_dir}"/**/main.pdf)
# First get the directory, and then strip all the leading directories as well
# This will leave us with the parent directory of the pdf
paths=("${pdfs[@]%/*}")
courses=("${paths[@]##*/}")

# After the user makes a selection, we use that to find the index of the element
# in 'courses' which is then used to find the full path using 'paths'
choice=$(IFS=$'\n'; echo "${courses[*]}" | menu -p "Course ")
path=""
for i in "${!courses[@]}"; do
   if [ "${courses[$i]}" = "$choice" ]; then
       path="${paths[${i}]}"
   fi
done

# We show another menu to allow the user to choose an action
#   View: view the pdf
#   Edit: edit the last numbered tex file (if you have 1-8.tex, then 8.tex will be edited)
#   Main: edit main.tex
#   File: edit a specific file
#   Add: adds a new section (if the last section was 7.tex, 8.tex will be created)
# It is not neccessary to have numbered texfiles like "1.tex 2.tex 3.tex ...",
# but it is neccessary for 'Add' and 'EditLast' to work.
if [[ -n "$choice" ]]; then
    action=$(echo -e "View\nEdit\nMain\nFile\nAdd" | menu -i -p "$choice ")
    case $action in
	"View")
	    xdg-open "${path}/${main_name}.pdf"
	    ;;
	"Main")
	    xdg-open "${path}/${main_name}.tex"
	    ;;
	"Edit" | "Add" | "File")
	    # Gets all tex files and get the filename only (plus extension)
	    files=("${path}"/*.tex)
	    filenames=("${files[@]##*/}")

	    if [ "$action" = "File" ]; then
		# Prompt user for desired file to edit
		file=$(IFS=$'\n'; echo "${filenames[*]}" | sort -g | menu -p "${choice}/ ")
		xdg-open "${path}/${file}"
		exit 0
	    fi

	    # Find the tex with the largest number. Since non-numbers bubble to
	    # the top with sort, it should be fine to just call tail on it
	    largest=$(IFS=$'\n'; echo "${filenames[*]}" | sort -g | tail -n 1)
	    if [ "$action" = "Edit" ]; then
		xdg-open "${path}/${largest}"
	    else
		num="${largest%.*}"
		next=$(( num + 1 ))
		touch "${path}/${next}.tex"
		xdg-open "${path}/${next}.tex"
	    fi
	    ;;
	*)
	    notify-send "Noteshow Error" "No action selected aborting..."
	    ;;
    esac
else
    notify-send "Noteshow Error" "No file selected aborting..."
fi
